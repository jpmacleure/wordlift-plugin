(function(){var a,b,c,d,e,f=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};b=function(){function a(a){this._html=a}var b;return a.prototype._htmlPositions=[],a.prototype._textPositions=[],a.prototype._html="",a.prototype._text="",b=function(a){var b;return b=document.createElement("textarea"),b.innerHTML=a,b.value},a.create=function(b){var c;return c=new a(b),c.parse(),c},a.version="1.0.0",a.prototype.parse=function(){var a,c,d,e,f,g,h,i,j,k,l;for(this._htmlPositions=[],this._textPositions=[],this._text="",h=/([^&<>]*)(&[^&;]*;|<[!\/]?(?:[\w-]+|\[cdata\[.*?]])(?: [\w_-]+(?:="[^"]*")?)*>)([^&<>]*)/gim,j=0,c=0;null!=(g=h.exec(this._html));)e=g[1],a=g[2],d=g[3],l=e+("</p>"===(i=a.toLowerCase())||"</li>"===i?"\n\n":""),k=d,j+=l.length,/^&[^&;]*;$/gim.test(a)&&(j+=1),c+=e.length+a.length,this._htmlPositions.push(c),this._textPositions.push(j),j+=k.length,c+=d.length,f="",/^&[^&;]*;$/gim.test(a)&&(f=b(a)),this._text+=l+f+k;if(""!==this._text||h.match(this._html)||(this._text=new String(this._html)),0===this._textPositions.length||0!==this._textPositions[0])return this._htmlPositions.unshift(0),this._textPositions.unshift(0)},a.prototype.text2html=function(a){var b,c,d,e,f;for(b=0,f=0,c=d=0,e=this._textPositions.length;(0<=e?d<e:d>e)&&!(a<this._textPositions[c]);c=0<=e?++d:--d)b=this._htmlPositions[c],f=this._textPositions[c];return b+a-f},a.prototype.html2text=function(a){var b,c,d,e,f;if(a<this._htmlPositions[0])return 0;for(b=0,f=0,c=d=0,e=this._htmlPositions.length;(0<=e?d<e:d>e)&&!(a<this._htmlPositions[c]);c=0<=e?++d:--d)b=this._htmlPositions[c],f=this._textPositions[c];return f+a-b},a.prototype.insertHtml=function(a,b){var c;return c=this.text2html(b.text),this._html=this._html.substring(0,c)+a+this._html.substring(c),this.parse()},a.prototype.getHtml=function(){return this._html},a.prototype.getText=function(){return this._text},a}(),window.Traslator=b,angular.module("wordlift.utils.directives",[]).directive("wlOnError",["$parse","$window","$log",function(a,b,c){return{restrict:"A",compile:function(b,c){return function(b,d){var e;return e=a(c.wlOnError),d.on("error",function(a){var c;return c=function(){return e(b,{$event:a})},b.$apply(c)})}}}}]).directive("wlFallback",["$window","$log",function(a,b){return{restrict:"A",priority:99,link:function(a,c,d,e){return c.bind("error",function(){if(d.src!==d.wlFallback)return b.warn("Error on "+d.src+"! Going to fallback on "+d.wlFallback),d.$set("src",d.wlFallback)})}}}]).directive("wlHideAfter",["$timeout","$log",function(a,b){return{restrict:"A",link:function(c,d,e,f){var g;return g=+e.wlHideAfter,a(function(){return b.debug("Remove msg after "+g+" ms"),d.hide()},g)}}}]).directive("wlClipboard",["$timeout","$document","$log",function(a,b,c){return{restrict:"E",scope:{text:"=",onCopied:"&"},transclude:!0,template:'<span \n  class="wl-widget-post-link" \n  ng-class="{\'wl-widget-post-link-copied\' : $copied}"\n  ng-click="copyToClipboard()">\n  <ng-transclude></ng-transclude>\n  <input type="text" ng-value="text" />\n</span>',link:function(d,e,f,g){return d.$copied=!1,d.node=e.find("input"),d.node.css("position","absolute"),d.node.css("left","-10000px"),d.copyToClipboard=function(){var e;try{if(b[0].body.style.webkitUserSelect="initial",e=b[0].getSelection(),e.removeAllRanges(),d.node.select(),b[0].execCommand("copy")||c.warn("Error on clipboard copy for "+text),e.removeAllRanges(),d.$copied=!0,a(function(){return c.debug("Going to reset $copied status"),d.$copied=!1},3e3),angular.isFunction(d.onCopied))return d.$evalAsync(d.onCopied())}finally{b[0].body.style.webkitUserSelect=""}}}}}]),angular.module("wordlift.ui.carousel",["ngTouch"]).directive("wlCarousel",["$window","$log",function(a,b){return{restrict:"A",scope:!0,transclude:!0,template:'<div class="wl-carousel" ng-class="{ \'active\' : areControlsVisible }" ng-show="panes.length > 0" ng-mouseover="showControls()" ng-mouseleave="hideControls()">\n  <div class="wl-panes" ng-style="{ width: panesWidth, left: position }" ng-transclude ng-swipe-left="next()" ng-swipe-right="prev()" ></div>\n  <div class="wl-carousel-arrows" ng-show="areControlsVisible" ng-class="{ \'active\' : isActive() }">\n    <i class="wl-angle left" ng-click="prev()" ng-show="isPrevArrowVisible()" />\n    <i class="wl-angle right" ng-click="next()" ng-show="isNextArrowVisible()" />\n  </div>\n</div>',controller:["$scope","$element","$attrs","$log",function(b,c,d,e){var f,g;return g=angular.element(a),b.setItemWidth=function(){return c.width()/b.visibleElements()},b.showControls=function(){return b.areControlsVisible=!0},b.hideControls=function(){return b.areControlsVisible=!1},b.visibleElements=function(){return c.width()>460?4:1},b.isActive=function(){return b.isPrevArrowVisible()||b.isNextArrowVisible()},b.isPrevArrowVisible=function(){return b.currentPaneIndex>0},b.isNextArrowVisible=function(){return b.panes.length-b.currentPaneIndex>b.visibleElements()},b.next=function(){if(!(b.currentPaneIndex+b.visibleElements()+1>b.panes.length))return b.position=b.position-b.itemWidth,b.currentPaneIndex=b.currentPaneIndex+1},b.prev=function(){if(0!==b.currentPaneIndex)return b.position=b.position+b.itemWidth,b.currentPaneIndex=b.currentPaneIndex-1},b.setPanesWrapperWidth=function(){return b.panesWidth=b.panes.length*b.itemWidth,b.position=0,b.currentPaneIndex=0},b.itemWidth=b.setItemWidth(),b.panesWidth=void 0,b.panes=[],b.position=0,b.currentPaneIndex=0,b.areControlsVisible=!1,g.bind("resize",function(){var a,c,d,e;for(b.itemWidth=b.setItemWidth(),b.setPanesWrapperWidth(),e=b.panes,a=0,c=e.length;a<c;a++)d=e[a],d.scope.setWidth(b.itemWidth);return b.$apply()}),f=this,f.registerPane=function(a,c,d){var e;return a.setWidth(b.itemWidth),e={scope:a,element:c},b.panes.push(e),b.setPanesWrapperWidth()},f.unregisterPane=function(a){var c,d,e,f,g,h;for(h=void 0,g=b.panes,c=d=0,e=g.length;d<e;c=++d)f=g[c],f.scope.$id===a.$id&&(h=c);return b.panes.splice(h,1),b.setPanesWrapperWidth()}}]}}]).directive("wlCarouselPane",["$log",function(a){return{require:"^wlCarousel",restrict:"EA",scope:{wlFirstPane:"="},transclude:!0,template:"<div ng-transclude></div>",link:function(b,c,d,e){return c.addClass("wl-carousel-item"),b.isFirst=b.wlFirstPane||!1,b.setWidth=function(a){return c.css("width",a+"px")},b.$on("$destroy",function(){return a.debug("Destroy "+b.$id),e.unregisterPane(b)}),e.registerPane(b,c,b.isFirst)}}}]),angular.module("wordlift.editpost.widget.controllers.EditPostWidgetController",["wordlift.editpost.widget.services.AnalysisService","wordlift.editpost.widget.services.EditorService","wordlift.editpost.widget.services.GeoLocationService","wordlift.editpost.widget.providers.ConfigurationProvider"]).filter("filterEntitiesByTypesAndRelevance",["configuration","$log",function(a,b){return function(a,b){var c,d,e,g,h;if(d=[],null==a)return d;h=Math.floor(1/120*Object.keys(a).length+.75);for(e in a)c=a[e],g=c.mainType,f.call(b,g)>=0&&d.push(c);return d}}]).filter("filterTruncate",["$log",function(a){return function(a,b){var c;return isNaN(b)?a:b<=0?"":(a&&(c=a.split(/\s+/),c.length>b&&(a=c.slice(0,b).join(" ")+"\u2026")),a)}}]).filter("filterSplitInRows",["$log",function(a){return function(a){var b,c;if(a)return a=Math.ceil(a),b=function(){c=[];for(var b=0,d=a-1;0<=d?b<=d:b>=d;0<=d?b++:b--)c.push(b);return c}.apply(this)}}]).filter("filterEntitiesByTypes",["$log",function(a){return function(a,b){var c,d,e,g;d=[];for(e in a)c=a[e],g=c.mainType,f.call(b,g)>=0&&d.push(c);return d}}]).filter("isEntitySelected",["$log",function(a){return function(a){var b,c,d;c=[];for(d in a)b=a[d],b.occurrences.length>0&&c.push(b);return c}}]).controller("EditPostWidgetController",["GeoLocationService","RelatedPostDataRetrieverService","EditorService","AnalysisService","configuration","$log","$scope","$rootScope",function(a,b,c,d,e,g,h,i){var j,k,l,m;for(h.isRunning=!1,h.isGeolocationRunning=!1,h.analysis=void 0,h.relatedPosts=void 0,h.currentEntity=void 0,h.currentEntityType=void 0,h.setCurrentEntity=function(a,b){var e;switch(h.currentEntity=a,h.currentEntityType=b,b){case"entity":return g.debug("An existing entity. Nothing to do");default:return g.debug("A new entity"),h.currentEntity=d.createEntity(),h.isThereASelection||null!=h.annotation?null!=h.annotation?(e=h.analysis.annotations[h.annotation],void(h.currentEntity.label=e.text)):c.createTextAnnotationFromCurrentSelection():(h.addMsg("Select a text or an existing annotation in order to create a new entity. Text selections are valid only if they do not overlap other existing annotation","error"),void h.unsetCurrentEntity())}},h.unsetCurrentEntity=function(){return h.currentEntity=void 0,h.currentEntityType=void 0},h.storeCurrentEntity=function(){if(!h.currentEntity.mainType)return void h.addMsg("Please do not forgive to specify a type for this entity!","error");switch(h.currentEntityType){case"entity":h.analysis.entities[h.currentEntity.id]=h.currentEntity,h.addMsg("The entity was updated!","positive");break;default:g.debug("Unset a new entity"),h.addNewEntityToAnalysis(),h.addMsg("The entity was created!","positive")}return h.unsetCurrentEntity(),wp.wordlift.trigger("analysis.result",h.analysis)},h.selectedEntities={},h.currentSection=void 0,h.toggleCurrentSection=function(a){return h.currentSection===a?h.currentSection=void 0:h.currentSection=a},h.isCurrentSection=function(a){return h.currentSection===a},h.suggestedPlaces=void 0,h.publishedPlace=e.publishedPlace,h.topic=void 0,null!=e.publishedPlace&&(h.suggestedPlaces={},h.suggestedPlaces[e.publishedPlace.id]=e.publishedPlace),h.annotation=void 0,h.boxes=[],h.images=[],h.isThereASelection=!1,h.configuration=e,h.messages=[],b.load(Object.keys(h.configuration.entities)),i.$on("analysisFailed",function(a,b){return h.addMsg(b,"error")}),i.$on("analysisServiceStatusUpdated",function(a,b){return h.isRunning=b,c.updateContentEditableStatus(!b)}),i.$watch("selectionStatus",function(){return h.isThereASelection=i.selectionStatus}),m=h.configuration.classificationBoxes,k=0,l=m.length;k<l;k++)j=m[k],h.selectedEntities[j.id]={};return h.removeMsg=function(a){return h.messages.splice(a,1)},h.addMsg=function(a,b){return h.messages.unshift({level:b,text:a})},h.selectAnnotation=function(a){return c.selectAnnotation(a)},h.hasAnalysis=function(){return null!=h.analysis},h.isEntitySelected=function(a,b){return null!=h.selectedEntities[b.id][a.id]},h.isLinkedToCurrentAnnotation=function(a){var b;return b=h.annotation,f.call(a.occurrences,b)>=0},h.addNewEntityToAnalysis=function(){var a;return delete h.currentEntity.suggestedSameAs,h.analysis.entities[h.currentEntity.id]=h.currentEntity,a=h.analysis.annotations[h.annotation],a.entityMatches.push({entityId:h.currentEntity.id,confidence:1}),h.analysis.entities[h.currentEntity.id].annotations[a.id]=a,h.analysis.annotations[h.annotation].entities[h.currentEntity.id]=h.currentEntity,h.onSelectedEntityTile(h.analysis.entities[h.currentEntity.id])},h.$on("updateOccurencesForEntity",function(a,b,c){var d,e,f;if(h.analysis.entities[b].occurrences=c,wp.wordlift.trigger("updateOccurrencesForEntity",{entityId:b,occurrences:c}),0===c.length){e=h.selectedEntities,f=[];for(j in e)d=e[j],f.push(delete h.selectedEntities[j][b]);return f}}),h.$watch("annotation",function(a){var b;if(g.debug("Current annotation id changed to "+a),!h.isRunning&&null!=a)return null!=h.currentEntity?(b=h.analysis.annotations[a],h.currentEntity.label=b.text,d.getSuggestedSameAs(b.text)):void 0}),h.$on("textAnnotationClicked",function(a,b){return h.annotation=b,h.unsetCurrentEntity()}),h.$on("textAnnotationAdded",function(a,b){return g.debug("added a new annotation with Id "+b.id),h.analysis.annotations[b.id]=b,h.annotation=b.id}),h.$on("sameAsRetrieved",function(a,b){return h.currentEntity.suggestedSameAs=b}),h.$on("relatedPostsLoaded",function(a,b){return h.relatedPosts=b}),h.$on("analysisPerformed",function(a,b){var c,d,e,i,k,l,m,n,o,p,q,r,s,t,u,v,w;if(h.analysis=b,null!=h.configuration.topic)for(r=b.topics,i=0,l=r.length;i<l;i++)w=r[i],s=w.id,f.call(h.configuration.topic.sameAs,s)>=0&&(h.topic=w);for(t=h.configuration.classificationBoxes,k=0,m=t.length;k<m;k++)for(j=t[k],u=j.selectedEntities,p=0,n=u.length;p<n;p++)if(d=u[p],c=b.entities[d]){if(0===c.occurrences.length){g.warn("Entity "+d+" selected as "+j.label+" without valid occurences!");continue}for(h.selectedEntities[j.id][d]=b.entities[d],v=c.images,q=0,o=v.length;q<o;q++)e=v[q],f.call(h.images,e)<0&&h.images.push(e)}else g.warn("Entity with id "+d+" should be linked to "+j.id+" but is missing");return h.currentSection="content-classification"}),h.updateRelatedPosts=function(){var a,c,d,e,f;g.debug("Going to update related posts box ..."),d=[],f=h.selectedEntities;for(j in f){a=f[j];for(e in a)c=a[e],d.push(e)}return b.load(d)},h.onSelectedEntityTile=function(a){var b,c,d,i,j,k,l;if(b="entitySelected",null!=h.annotation?(j=h.annotation,f.call(a.occurrences,j)>=0&&(b="entityDeselected")):a.occurrences.length>0&&(b="entityDeselected"),l=e.getCategoryForType(a.mainType),g.debug("Action '"+b+"' on entity "+a.id+" within "+l+" scope"),"entitySelected"===b)for(h.selectedEntities[l][a.id]=a,k=a.images,d=0,i=k.length;d<i;d++)c=k[d],f.call(h.images,c)<0&&h.images.push(c);else h.images=h.images.filter(function(b){return f.call(a.images,b)<0});return h.$emit(b,a,h.annotation),wp.wordlift.trigger(b,{entity:a,annotation:h.annotation}),h.updateRelatedPosts(),h.selectAnnotation(void 0)},h.isGeoLocationAllowed=function(){return a.isAllowed()},h.getLocation=function(){return h.isGeolocationRunning=!0,i.$broadcast("geoLocationStatusUpdated",h.isGeolocationRunning),a.getLocation()},h.isPublishedPlace=function(a){var b;return a.id===(null!=(b=h.publishedPlace)?b.id:void 0)},h.hasPublishedPlace=function(){return null!=h.publishedPlace||null!=h.suggestedPlaces},h.onPublishedPlaceSelected=function(a){var b;return(null!=(b=h.publishedPlace)?b.id:void 0)===a.id?(h.publishedPlace=void 0,void(h.suggestedPlaces=void 0)):h.publishedPlace=a},h.$on("currentUserLocalityDetected",function(a,b,c){return g.debug("Looking for entities matching "+b+" for locality "+c),d._innerPerform(b).then(function(a){var b,d,e;h.suggestedPlaces={},e=a.data.entities;for(d in e)b=e[d],"place"===b.mainType&&c===b.label&&(b.id=d,h.onPublishedPlaceSelected(b));return h.isGeolocationRunning=!1,i.$broadcast("geoLocationStatusUpdated",h.isGeolocationRunning)})}),h.$on("geoLocationError",function(a,b){return h.addMsg("Sorry. Looks like something went wrong and WordLift cannot detect your current position. Make sure the \u200blocation services\u200b of your browser are turned on.","error"),h.isGeolocationRunning=!1,i.$broadcast("geoLocationStatusUpdated",h.isGeolocationRunning)}),h.isTopic=function(a){var b;return a.id===(null!=(b=h.topic)?b.id:void 0)},h.onTopicSelected=function(a){var b;return(null!=(b=h.topic)?b.id:void 0)===a.id?void(h.topic=void 0):h.topic=a}}]),angular.module("wordlift.editpost.widget.directives.wlClassificationBox",[]).directive("wlClassificationBox",["configuration","$log",function(a,b){return{restrict:"E",scope:!0,transclude:!0,templateUrl:function(){return a.defaultWordLiftPath+"templates/wordlift-widget-be/wordlift-directive-classification-box.html"},link:function(a,b,c,d){return a.hasSelectedEntities=function(){return Object.keys(a.selectedEntities[a.box.id]).length>0},wp.wordlift.trigger("wlClassificationBox.loaded",a)},controller:function(a,b,c){var d;return a.tiles=[],a.boxes[a.box.id]=a,d=this,d.addTile=function(b){return a.tiles.push(b)},d.closeTiles=function(){var b,c,d,e,f;for(d=a.tiles,e=[],b=0,c=d.length;b<c;b++)f=d[b],e.push(f.isOpened=!1);return e}}}}]),angular.module("wordlift.editpost.widget.directives.wlEntityList",[]).directive("wlEntityList",["$log",function(a){return{restrict:"A",link:function(){return wp.wordlift.trigger("wlEntityList.loaded")}}}]),angular.module("wordlift.editpost.widget.directives.wlEntityForm",[]).directive("wlEntityForm",["configuration","$window","$log",function(a,b,c){return{restrict:"E",scope:{entity:"=",onSubmit:"&",onReset:"&",box:"="},templateUrl:function(){return a.defaultWordLiftPath+"templates/wordlift-widget-be/wordlift-directive-entity-form.html"},link:function(d,e,g,h){return d.configuration=a,d.currentCategory=void 0,d.$watch("entity.id",function(b){var e,f;if(null!=b)return c.debug("Entity updated to "+b),e=a.getCategoryForType(null!=(f=d.entity)?f.mainType:void 0),c.debug("Going to update current category to "+e),d.currentCategory=e}),d.onSubmitWrapper=function(a){return a.preventDefault(),d.onSubmit()},d.onResetWrapper=function(a){return a.preventDefault(),d.onReset()},d.setCurrentCategory=function(b){var e;if(d.currentCategory=b,e=a.getTypesForCategoryId(b),c.debug("Going to check types"),c.debug(e),1===e.length)return d.setType(e[0])},d.unsetCurrentCategory=function(){var a;return d.currentCategory=void 0,null!=(a=d.entity)?a.mainType=void 0:void 0},d.isSameAsOf=function(a){var b;return b=a.id,f.call(d.entity.sameAs,b)>=0},d.addSameAs=function(a){var b,c,e,g,h;return(null!=(c=d.entity)?c.sameAs:void 0)||null!=(e=d.entity)&&(e.sameAs=[]),g=a.id,f.call(d.entity.sameAs,g)>=0?(b=d.entity.sameAs.indexOf(a.id),d.entity.sameAs.splice(b,1)):null!=(h=d.entity)?h.sameAs.push(a.id):void 0},d.setType=function(a){var b,c;if(a!==(null!=(b=d.entity)?b.mainType:void 0))return null!=(c=d.entity)?c.mainType=a:void 0},d.isCurrentType=function(a){var b;return(null!=(b=d.entity)?b.mainType:void 0)===a},d.getAvailableTypes=function(){return a.getTypesForCategoryId(d.currentCategory)},d.removeCurrentImage=function(a){var b;return b=d.entity.images.splice(a,1),c.warn("Removed "+b+" from entity "+d.entity.id+" images collection")},d.linkToEdit=function(a){return a.preventDefault(),b.location.href=ajaxurl+"?action=wordlift_redirect&uri="+b.encodeURIComponent(d.entity.id)+"&to=edit"},d.hasOccurences=function(){var a;return(null!=(a=d.entity.occurrences)?a.length:void 0)>0},d.setSameAs=function(a){return d.entity.sameAs=a},d.isInternal=function(){var b;return a.isInternal(null!=(b=d.entity)?b.id:void 0)},d.isNew=function(a){var b;return!/^(f|ht)tps?:\/\//i.test(null!=(b=d.entity)?b.id:void 0)}}}}]),angular.module("wordlift.editpost.widget.directives.wlEntityTile",[]).directive("wlEntityTile",["configuration","$log",function(a,b){return{require:"?^wlClassificationBox",restrict:"E",scope:{entity:"=",isSelected:"=",showConfidence:"=",onSelect:"&",onMore:"&"},templateUrl:function(){return a.defaultWordLiftPath+"templates/wordlift-widget-be/wordlift-directive-entity-tile.html"},link:function(b,c,d,e){return b.configuration=a,null!=e&&e.addTile(b),b.isOpened=!1,b.isInternal=function(){return!!b.entity.id.startsWith(a.datasetUri)},b.toggle=function(){return b.isOpened||null!=e&&e.closeTiles(),b.isOpened=!b.isOpened}}}}]),angular.module("wordlift.editpost.widget.directives.wlEntityInputBox",[]).directive("wlEntityInputBox",["configuration","$log",function(a,b){return{restrict:"E",scope:{entity:"="},templateUrl:function(){return a.defaultWordLiftPath+"templates/wordlift-widget-be/wordlift-directive-entity-input-box.html"}}}]),angular.module("wordlift.editpost.widget.services.EditorAdapter",["wordlift.editpost.widget.services.EditorAdapter"]).service("EditorAdapter",["$log",function(a){var b;return b={getEditor:function(a){return null==a&&(a="content"),tinyMCE.get(a)},getHTML:function(a){return b.getEditor(a).getContent({format:"raw"})}}}]),angular.module("wordlift.editpost.widget.services.AnnotationParser",[]).service("AnnotationParser",["$log",function(a){var c;return c={parse:function(a){var c,d,e,f,g;for(g=b.create(a),e=/<(\w+)[^>]*\sitemid="([^"]+)"[^>]*>([^<]*)<\/\1>/gim,f=[];d=e.exec(a);)c={start:g.html2text(d.index),end:g.html2text(d.index+d[0].length),uri:d[2],label:d[3]},f.push(c);return f}}}]),angular.module("wordlift.editpost.widget.services.AnalysisService",["wordlift.editpost.widget.services.AnnotationParser","wordlift.editpost.widget.services.EditorAdapter"]).service("AnalysisService",["AnnotationParser","EditorAdapter","configuration","$log","$http","$rootScope",function(a,c,d,e,g,h){var i,j,k,l,m,n,o,p,q,r,s,t,u;for(u=function(a){var b;for(null==a&&(a=8),b="";b.length<a;)b+=Math.random().toString(36).substr(2);return b.substr(0,a)},p=function(a,b){return j(j({},a),b)},j=function(a,b){var c,d;for(c in b)d=b[c],a[c]=d;return a},k=function(a,b,c){var d,e;for(e in a)if(d=a[e],d.start===b&&d.end===c)return d},s={_isRunning:!1,_currentAnalysis:void 0,_supportedTypes:[],_defaultType:"thing"},s.cleanAnnotations=function(a,b){var c,d,g,h,i,j,k,l,m,n;null==b&&(b=[]),l=a.annotations;for(d in l)if(c=l[d],c.start>0&&c.end>c.start){for(g=function(){n=[];for(var a=m=c.start,b=c.end;m<=b?a<=b:a>=b;m<=b?a++:a--)n.push(a);return n}.apply(this),h=!1,i=0,j=g.length;i<j;i++){k=g[i],f.call(b,k)>=0&&(h=!0);break}h?(e.warn("Annotation with id: "+d+" start: "+c.start+" end: "+c.end+" overlaps an existing annotation"),this.deleteAnnotation(a,d)):b=b.concat(g)}return a},q=d.classificationBoxes,l=0,n=q.length;l<n;l++)for(i=q[l],r=i.registeredTypes,m=0,o=r.length;m<o;m++)t=r[m],f.call(s._supportedTypes,t)<0&&s._supportedTypes.push(t);return s.createEntity=function(a){var b;return null==a&&(a={}),b={id:"local-entity-"+u(32),label:"",description:"",mainType:"",types:[],images:[],confidence:1,occurrences:[],annotations:{}},p(b,a)},s.deleteAnnotation=function(a,b){var c,d,f,g,h;if(e.warn("Going to remove overlapping annotation with id "+b),null!=a.annotations[b]){for(h=a.annotations[b].entityMatches,d=f=0,g=h.length;f<g;d=++f)c=h[d],delete a.entities[c.entityId].annotations[b];delete a.annotations[b]}return a},s.createAnnotation=function(a){var b;return null==a&&(a={}),b={id:"urn:local-text-annotation-"+u(32),text:"",start:0,end:0,entities:[],entityMatches:[]},p(b,a)},s.parse=function(a){var b,c,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B;g=this._defaultType,a.topics=a.topics.map(function(a){return a.id=a.uri,a.occurrences=[],a.mainType=g,a}),u=d.entities;for(k in u)p=u[k],a.entities[k]=p;v=a.entities;for(k in v)j=v[k],d.currentPostUri!==k?(j.label||e.warn("Label missing for entity "+k),j.description||e.warn("Description missing for entity "+k),j.sameAs||(e.warn("sameAs missing for entity "+k),j.sameAs=[],null!=(w=d.entities[k])&&(w.sameAs=[]),e.debug("Schema.org sameAs overridden for entity "+k)),x=j.mainType,f.call(this._supportedTypes,x)<0&&(e.warn("Schema.org type "+j.mainType+" for entity "+k+" is not supported from current classification boxes configuration"),j.mainType=this._defaultType,null!=(y=d.entities[k])&&(y.mainType=this._defaultType),e.debug("Schema.org type overridden for entity "+k)),j.id=k,j.occurrences=[],j.annotations={},j.confidence=1):delete a.entities[k];z=a.annotations;for(k in z)if(b=z[k],b.id=k,b.entities={},a.annotations[k].entityMatches=function(){var c,d,e,f;for(e=b.entityMatches,f=[],c=0,d=e.length;c<d;c++)h=e[c],h.entityId in a.entities&&f.push(h);return f}(),0!==a.annotations[k].entityMatches.length)for(A=a.annotations[k].entityMatches,l=m=0,n=A.length;m<n;l=++m)h=A[l],a.entities[h.entityId].label||(a.entities[h.entityId].label=b.text,e.debug("Missing label retrieved from related annotation for entity "+h.entityId)),a.entities[h.entityId].annotations[k]=b,a.annotations[k].entities[h.entityId]=a.entities[h.entityId];else delete a.annotations[k];B=a.entities;for(k in B){j=B[k],s=a.annotations;for(c in s){for(b=s[c],q=1,t=b.entityMatches,r=0,o=t.length;r<o;r++)i=t[r],null!=i.entityId&&i.entityId===k&&(q=i.confidence);j.confidence=j.confidence*q}}return a},s.getSuggestedSameAs=function(a){var b,c,d,f,g,i;f=this._innerPerform(a).then(function(a){}),i=[],g=response.data.entities;for(c in g)b=g[c],(d=c.match(/^https?\:\/\/([^\/?#]+)(?:[\/?#]|$)/i))&&i.push({id:c,label:b.label,mainType:b.mainType,source:d[1]});return e.debug(i),h.$broadcast("sameAsRetrieved",i)},s._innerPerform=function(a,c){var d;return null==c&&(c=[]),d={method:"post",url:ajaxurl+"?action=wordlift_analyze"},d.headers={"Content-Type":"application/json"},d.data={content:a,annotations:c,contentType:"text/html",version:b.version},"undefined"!=typeof wlSettings&&null!==wlSettings&&(null!=wlSettings.language&&(d.data.contentLanguage=wlSettings.language),null!=wlSettings.itemId&&(d.data.exclude=[wlSettings.itemId])),g(d)},s._updateStatus=function(a){return s._isRunning=a,h.$broadcast("analysisServiceStatusUpdated",a)},s.perform=function(b){var d,f;return s._currentAnalysis?(e.warn("Analysis already run! Nothing to do ..."),void s._updateStatus(!1)):(s._updateStatus(!0),d=a.parse(c.getHTML()),e.debug("Requesting analysis..."),f=this._innerPerform(b,d),f.then(function(a){var b;return s._currentAnalysis=a.data,b=s.parse(a.data),h.$broadcast("analysisPerformed",b),wp.wordlift.trigger("analysis.result",b)}),f.catch(function(a){return e.error(a.data),h.$broadcast("analysisFailed",a.data)}),f.finally(function(a){return s._updateStatus(!1)}))},s.preselect=function(a,b){var c,g,h,i,j,l,m,n,o,p;for(e.debug("Selecting entity annotations ("+b.length+")..."),o=[],j=0,l=b.length;j<l;j++)if(c=b[j],c.start!==c.end){p=k(a.annotations,c.start,c.end),null==p&&(e.warn("Text annotation "+c.start+":"+c.end+" for entityId "+c.uri+" misses in the analysis"),p=this.createAnnotation({start:c.start,end:c.end,text:c.label,cssClass:null!=c.cssClass?c.cssClass:void 0}),a.annotations[p.id]=p),h=a.entities[c.uri],m=d.entities;for(i in m)g=m[i],n=c.uri,f.call(g.sameAs,n)>=0&&(h=a.entities[g.id]);null!=h?(a.entities[h.id].occurrences.push(p.id),null==a.entities[h.id].annotations[p.id]?(a.entities[h.id].annotations[p.id]=p,a.annotations[p.id].entityMatches.push({entityId:h.id,confidence:1}),o.push(a.annotations[p.id].entities[h.id]=a.entities[h.id])):o.push(void 0)):e.warn("Entity with uri "+c.uri+" is missing both in analysis results and in local storage")}else e.warn("There is a broken empty annotation for entityId "+c.uri);return o},s}]),angular.module("wordlift.editpost.widget.services.EditorService",["wordlift.editpost.widget.services.EditorAdapter","wordlift.editpost.widget.services.AnalysisService"]).service("EditorService",["configuration","AnalysisService","EditorAdapter","$log","$http","$rootScope",function(a,c,d,e,g,h){var i,j,k,l,m,n,o,p;return i="\ufeff",n=function(a){var c,d,e,f,g;for(g=b.create(a),e=/<(\w+)[^>]*\sclass="([^"]+)"\sitemid="([^"]+)"[^>]*>([^<]*)<\/\1>/gim,f=[];d=e.exec(a);)c={start:g.html2text(d.index),end:g.html2text(d.index+d[0].length),uri:d[3],label:d[4],cssClass:d[2]},f.push(c);return f},o=function(a){var b,c,d,e,f,g;for(e=[],c=0,d=a.length;c<d;c++)b=a[c],e=e.concat(function(){g=[];for(var a=f=b.start,c=b.end;f<=c?a<=c:a>=c;f<=c?a++:a--)g.push(a);return g}.apply(this));return e},m=function(){return tinyMCE.get("content")},l=function(b,c){var e,f,g,h,i,j;for(f=d.getEditor(),f.dom.addClass(b,"disambiguated"),i=a.types,g=0,h=i.length;g<h;g++)j=i[g],f.dom.removeClass(b,j.css);return f.dom.removeClass(b,"unlinked"),f.dom.addClass(b,"wl-"+c.mainType),e=f.dom.getAttrib(b,"itemid"),f.dom.setAttrib(b,"itemid",c.id),e},k=function(a,b){var c,e;return e=d.getEditor(),e.dom.removeClass(a,"disambiguated"),e.dom.removeClass(a,"wl-"+b.mainType),c=e.dom.getAttrib(a,"itemid"),e.dom.setAttrib(a,"itemid",""),c},j=function(a){var b,c,e,f,g,h,i;if(e=d.getEditor(),i=[],""===a)return i;for(c=e.dom.select("span.textannotation"),g=0,h=c.length;g<h;g++)b=c[g],f=e.dom.getAttrib(b.id,"itemid"),f===a&&i.push(b.id);return i},h.$on("analysisPerformed",function(a,b){if(null!=b&&null!=b.annotations)return p.embedAnalysis(b)}),h.$on("entitySelected",function(a,b,c){var d,e,f,g,i,k,m,n;if(e=[],null!=c)e.push(l(c,b));else{n=b.annotations;for(g in n)d=n[g],e.push(l(d.id,b))}for(i=0,k=e.length;i<k;i++)f=e[i],f&&(m=j(f),h.$broadcast("updateOccurencesForEntity",f,m));return m=j(b.id),h.$broadcast("updateOccurencesForEntity",b.id,m)}),h.$on("entityDeselected",function(a,b,c){var d,e,f,g;if(null!=c)k(c,b);else{g=b.annotations;for(e in g)d=g[e],k(d.id,b)}return f=j(b.id),h.$broadcast("updateOccurencesForEntity",b.id,f)}),p={hasSelection:function(){var a,b;return a=d.getEditor(),null!=a&&(!a.selection.isCollapsed()&&(b=/<([\/]*[a-z]+)[^<]*>/,!b.test(a.selection.getContent())||(e.warn("The selection overlaps html code"),!1)))},isEditor:function(a){var b;return b=d.getEditor(),b.id===a.id},updateContentEditableStatus:function(a){var b;return b=d.getEditor(),b.getBody().setAttribute("contenteditable",a)},createTextAnnotationFromCurrentSelection:function(){var a,f,g,j,k,l,m,n;return f=d.getEditor(),f.selection.isCollapsed()?void e.warn("Invalid selection! The text annotation cannot be created"):(j=""+f.selection.getSel(),k=c.createAnnotation({text:j}),l='<span id="'+k.id+'" class="textannotation unlinked selected">'+f.selection.getContent()+"</span>"+i,f.selection.setContent(l),a=d.getHTML(),n=b.create(a),g=a.indexOf(l),m=n.html2text(g),k.start=m,k.end=k.start+j.length,h.$broadcast("textAnnotationAdded",k))},selectAnnotation:function(a){var b,c,e,f,g;for(c=d.getEditor(),g=c.dom.select("span.textannotation"),e=0,f=g.length;e<f;e++)b=g[e],c.dom.removeClass(b.id,"selected");if(h.$broadcast("textAnnotationClicked",void 0),c.dom.hasClass(a,"textannotation"))return c.dom.addClass(a,"selected"),h.$broadcast("textAnnotationClicked",a)},embedAnalysis:function(a){return function(a){var g,j,k,l,m,p,q,r,s,t,u,v,w,x,y;for(k=d.getEditor(),r=d.getHTML(),p=n(r),c.cleanAnnotations(a,o(p)),c.preselect(a,p);r.match(/<(\w+)[^>]*\sclass="textannotation[^"]*"[^>]*>([^<]+)<\/\1>/gim,"$2");)r=r.replace(/<(\w+)[^>]*\sclass="textannotation[^"]*"[^>]*>([^<]*)<\/\1>/gim,"$2");y=b.create(r),v=a.annotations;for(j in v)if(g=v[j],0!==g.entityMatches.length){for(l='<span id="'+j+'" class="textannotation',-1<(null!=(w=g.cssClass)?w.indexOf("wl-no-link"):void 0)&&(l+=" wl-no-link"),x=g.entityMatches,t=0,u=x.length;t<u;t++)m=x[t],q=a.entities[m.entityId],f.call(q.occurrences,j)>=0&&(l+=" disambiguated wl-"+q.mainType+'" itemid="'+q.id);l+='">',y.insertHtml(l,{text:g.start}),y.insertHtml("</span>",{text:g.end})}else e.warn("Annotation "+g.text+" ["+g.start+":"+g.end+"] with id "+g.id+" has no entity matches!");return r=y.getHtml(),r=r.replace(/<\/span>/gim,"</span>"+i),h.$broadcast("analysisEmbedded"),s=k.isDirty(),k.setContent(r,{format:"raw"}),k.isNotDirty=!s}}(this)}}]),angular.module("wordlift.editpost.widget.services.RelatedPostDataRetrieverService",[]).service("RelatedPostDataRetrieverService",["configuration","$log","$http","$rootScope",function(a,b,c,d){var e;return e={},e.load=function(e){var f;return null==e&&(e=[]),f="admin-ajax.php?action=wordlift_related_posts&post_id="+a.currentPostId,c({method:"post",url:f,data:e}).success(function(a){return d.$broadcast("relatedPostsLoaded",a)}).error(function(a,c){return b.warn("Error loading related posts")})},e}]),angular.module("wordlift.editpost.widget.services.GeoLocationService",["geolocation"]).service("GeoLocationService",["configuration","geolocation","$log","$rootScope","$document","$q","$timeout","$window",function(a,b,c,d,e,g,h,i){var j,k,l,m,n,o;return l="locality",k="AIzaSyAhsajbqNVd7ABlkZvskWIPdiX6M3OaaNM",j="https://maps.googleapis.com/maps/api/js?language="+a.currentLanguage+"&key="+k,d.$on("error",function(a,b){return c.warn("Geolocation error: "+b),d.$broadcast("geoLocationError",b)}),this.googleApiLoaded=!1,this.googleApiPromise=void 0,n=function(){var a,b,c;return null!=this.googleApiPromise?this.googleApiPromise:(b=g.defer(),c=e[0].createElement("script"),c.src=j,e[0].body.appendChild(c),a=function(a){var d;if(!c.readyState||"complete"===(d=c.readyState)||"loaded"===d)return h(function(){return b.resolve(a)})},c.onload=a,c.onreadystatechange=a,c.onerror=function(a){return h(function(){return b.reject(a)})},this.googleApiPromise=b.promise,this.googleApiPromise)},m=function(){var a,b,c;c=i.navigator.userAgent,a={chrome:/chrome/i,safari:/safari/i,firefox:/firefox/i,ie:/internet explorer/i};for(b in a)if(a[b].test(c))return b;return"unknown"},o={},o.isAllowed=function(){return"chrome"!==m()||"https:"===i.location.protocol;
},o.getLocation=function(){return b.getLocation().then(function(a){return c.debug("Detected position: latitude "+a.coords.latitude+", longitude "+a.coords.longitude),n().then(function(){var b;return b=new google.maps.Geocoder,b.geocode({location:{lat:a.coords.latitude,lng:a.coords.longitude}},function(a,b){var c,e,g,h,i,j,k;if(b===google.maps.GeocoderStatus.OK)for(e=0,h=a.length;e<h;e++)if(k=a[e],f.call(k.types,l)>=0)for(j=k.address_components,g=0,i=j.length;g<i;g++)if(c=j[g],f.call(c.types,l)>=0)return void d.$broadcast("currentUserLocalityDetected",k.formatted_address,c.long_name)})})})},o}]),angular.module("wordlift.editpost.widget.providers.ConfigurationProvider",[]).provider("configuration",function(){var a,b;return a=void 0,b={setConfiguration:function(b){return a=b,a.getCategoryForType=function(a){var b,c,d,e;if(a)for(e=this.classificationBoxes,c=0,d=e.length;c<d;c++)if(b=e[c],f.call(b.registeredTypes,a)>=0)return b.id},a.getTypesForCategoryId=function(a){var b,c,d,e;if(!a)return[];for(e=this.classificationBoxes,c=0,d=e.length;c<d;c++)if(b=e[c],a===b.id)return b.registeredTypes},a.isInternal=function(a){return null!=a?a.startsWith(this.datasetUri):void 0},a.getUriForType=function(a){var b,c,d,e;for(d=this.types,b=0,c=d.length;b<c;b++)if(e=d[b],e.css==="wl-"+a)return e.uri}},$get:function(){return a}}}),a=jQuery,angular.module("wordlift.editpost.widget",["ngAnimate","wordlift.ui.carousel","wordlift.utils.directives","wordlift.editpost.widget.providers.ConfigurationProvider","wordlift.editpost.widget.controllers.EditPostWidgetController","wordlift.editpost.widget.directives.wlClassificationBox","wordlift.editpost.widget.directives.wlEntityList","wordlift.editpost.widget.directives.wlEntityForm","wordlift.editpost.widget.directives.wlEntityTile","wordlift.editpost.widget.directives.wlEntityInputBox","wordlift.editpost.widget.services.AnalysisService","wordlift.editpost.widget.services.EditorService","wordlift.editpost.widget.services.RelatedPostDataRetrieverService"]).config(function(a){return a.setConfiguration(window.wordlift)}),a(c=a('<div\n      id="wordlift-edit-post-wrapper"\n      ng-controller="EditPostWidgetController"\n      ng-include="configuration.defaultWordLiftPath + \'templates/wordlift-widget-be/wordlift-editpost-widget.html\'">\n    </div>').appendTo("#wordlift-edit-post-outer-wrapper"),e=a('<div class="wl-widget-spinner">\n  <svg transform-origin="10 10" id="wl-widget-spinner-blogger">\n    <circle cx="10" cy="10" r="6" class="wl-blogger-shape"></circle>\n  </svg>\n  <svg transform-origin="10 10" id="wl-widget-spinner-editorial">\n    <rect x="4" y="4" width="12" height="12" class="wl-editorial-shape"></rect>\n  </svg>\n  <svg transform-origin="10 10" id="wl-widget-spinner-enterprise">\n    <polygon points="3,10 6.5,4 13.4,4 16.9,10 13.4,16 6.5,16" class="wl-enterprise-shape"></polygon>\n  </svg>\n</div> ').appendTo("#wordlift_entities_box .ui-sortable-handle"),d=angular.bootstrap(a("#wordlift-edit-post-wrapper"),["wordlift.editpost.widget"]),d.invoke(["$rootScope","$log",function(b,c){return b.$on("analysisServiceStatusUpdated",function(b,c){var d;return d=c?"wl-spinner-running":"",a(".wl-widget-spinner svg").attr("class",d)}),b.$on("geoLocationStatusUpdated",function(b,c){var d;return d=c?"wl-spinner-running":"",a(".wl-widget-spinner svg").attr("class",d)})}]),tinymce.PluginManager.add("wordlift",function(a,b){var c;if("content"===a.id)return c=function(a,b,c){switch(tinymce.majorVersion){case"4":return a.on(b,c);case"3":return a["on"+b].add(c)}},d.invoke(["EditorService","$rootScope","$log",function(a,b,c){var d,e,f,g,h,i;for(null!=wp.autosave&&(wp.autosave.server.postChanged=function(){return!1}),h=["setMarkers","toViews"],i=[],d=0,e=h.length;d<e;d++){if(f=h[d],null!=wp.mce.views[f]){g=wp.mce.views[f],c.warn("Override wp.mce.views method "+f+"() to prevent shortcodes rendering"),wp.mce.views[f]=function(a){return a},b.$on("analysisEmbedded",function(a){return c.info("Going to restore wp.mce.views method "+f+"()"),wp.mce.views[f]=g}),b.$on("analysisFailed",function(a){return c.info("Going to restore wp.mce.views method "+f+"()"),wp.mce.views[f]=g});break}i.push(void 0)}return i}]),c(a,"LoadContent",function(b){return d.invoke(["AnalysisService","EditorService","$rootScope","$log",function(b,c,d,e){return d.$apply(function(){var d;if(d=a.getContent({format:"raw"}),""!==d)return c.updateContentEditableStatus(!1),b.perform(d)})}])}),c(a,"NodeChange",function(a){return d.invoke(["AnalysisService","EditorService","$rootScope","$log",function(a,b,c,d){return a._currentAnalysis&&c.$apply(function(){return c.selectionStatus=b.hasSelection()}),!0}])}),c(a,"Click",function(a){return d.invoke(["AnalysisService","EditorService","$rootScope","$log",function(b,c,d,e){return b._currentAnalysis&&d.$apply(function(){return c.selectAnnotation(a.target.id)}),!0}])})}))}).call(this);